<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Django unchained</title>
        <meta name="description" content="Kvalifikacijski ispit">
        <meta name="author" content="Damir Arbula">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="vendor/reveal.js/css/reveal.css">
        <link rel="stylesheet" href="vendor/reveal.js/lib/css/zenburn.css">
        <link rel="stylesheet" href="theme/django.css" id="theme">
        <!--
        <link rel="stylesheet" href="vendor/reveal.js/css/theme/night.css" id="theme">
        -->
        <!-- For syntax highlighting -->
        <!-- If the query includes 'print-pdf', use the PDF print sheet -->
        <script>
            document.write( '<link rel="stylesheet" href="vendor/reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
        </script>
        <!--[if lt IE 9]>
        <script src="vendor/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

<body>
<div class="reveal">

<div class="slides">

<section data-markdown>
<script type="text/template">
# Django unchained
## Damir Arbula
### LKLK 2016
https://darbula.github.io/lklk2016
</script>
<aside class="notes">
    Napomene
</aside>
</section>

<section data-markdown>
<script type="text/template">
## Introspekcija
* FER
    * Radiokomunikacije (dipl.ing 2002.),
    * Raspodijeljeni algoritmi (mr.sc. 2008.)
    * Bežične mreže osjetila (dr.sc. 2014.)
* postdoktorand na Ritehu (ASP, BMO, RWA)
* Django
    * od 2011
    * Do sada 10ak projekata
        * Servus management system
        * django onlinejudge - asp.riteh.hr, programiranje.riteh.hr
        * www.riteh.hr
</script>
</section>

<section data-markdown>
<script type="text/template">
## O Djangu
* Django? Unchained?

![](https://pmcvariety.files.wordpress.com/2015/12/django-unchained-jamie-foxx.jpg?w=670&h=377&crop=1)

NOT <!-- .element: style="color: red" -->
</script>
</section>

<section data-markdown>
## O Djangu
* Django Reinhardt

![](https://i.ytimg.com/vi/ooHp0aMf598/maxresdefault.jpg)

</section>

<section data-markdown>
<script type="text/template">
## O Djangu
> *Django is a high-level Python Web framework that encourages rapid development and clean, pragmatic design.*

* 2003: razvoj, Adrian Holovaty, Simon Wilson
* 2005: 1st release v0.9
* 2008: Django Software foundation, DjangoCon
* Pokreće:
    * Disqus, Pinterest, Instagram
    * Bitbucket, dpaste
    * PBS, Washington times, Mozilla support...
</script>
</section>

<section data-markdown>
<script type="text/template">
## O djangu

* Razvoj u Djangu:
    * Brz
    * Zabavan - većina dosadnih taskova je automatizirana
    * DRY - don’t repeat yourself

* Django aplikacija
    * obavlja jedan i samo jedan zadatak
    * reusable
    * velik izbor gotovih aplikacija

* Django Projekt
    * skup Django aplikacija

</script>
</section>


<section data-markdown>
<script type="text/template">
## O Vama
![](http://www.wired.com/wp-content/uploads/2015/12/clickbait-594373451-1024x767.jpg) <!-- .element: width="50%" -->

* HTML, CSS, JS
* Python
* Webapps
</script>
</section>


<section data-markdown>
<script type="text/template">
## O radionici
* Uvodno predavanje - teorija

![](images/boring.jpg) <!-- .element: width="30%" -->

* One page app <!-- .element: class="fragment" data-fragment-index="1" -->
* Django tutorial a.k.a. Polls <!-- .element: class="fragment" data-fragment-index="2" -->
</script>
</section>

<section data-markdown>
<script type="text/template">
## Web

* apps & sites
* klijent - server arhitektura
    * klijent a.k.a. *User Agent* je u većini slučajeva browser
* komunikacijski protokol: HTTP

![](http://www.ibm.com/developerworks/aix/library/au-perf_tuning/figure1.gif)
</script>
</section>

<section data-markdown>
<script type="text/template">
## HTTP

* URL - adresa resursa
* zaglavlje i tijelo
* Zahtjev: metode GET, HEAD, POST, PUT, DELETE, TRACE...
    * safe (GET, HEAD, TRACE) idempotent (PUT, DELETE) cacheable odgovori
* Odgovor:
    * 1xx Information: 100 Continue
    * 2xx Success: 200 OK, 201 Created...
    * 3xx Redirection: 301 Moved Permanently, 302 Found
    * 4xx Client Error: 403 Forbidden, 404 Not Found
    * 5xx Server Error: 500 Internal Server Error, 502 Bad Gateway
</script>
</section>

<section data-markdown>
<script type="text/template">
## HTTP primjer
Zahtjev:

```
GET /index.html HTTP/1.1
Host: www.example.com
```
Odgovor:

```
HTTP/1.1 200 OK
Date: Mon, 09 Jan 2016 22:38:34 GMT
Server: Apache/1.3.3.7 (Unix) (Red-Hat/Linux)
Last-Modified: Wed, 08 Jan 2016 23:11:55 GMT
Content-Type: text/html; charset=UTF-8
Content-Length: 138

<html>
<head>
  <title>An Example Page</title>
</head>
<body>
  Hello World, this is a very simple HTML document.
</body>
</html>
```
</script>
</section>


<section data-markdown>
<script type="text/template">

## Izvan Djanga

* **HTTP server & reverse proxy:**
    * nginx, Apache
* **Pohrana podataka:**
    * PostgreSQL, MySQL, NoSQL, Redis
* **Cache:**
    * Redis, memcached
* **Indeksiranje i pretraživanje:**
    * Elasticsearch
* **Message broker:**
    * RabbitMQ, Redis
* **Task queue:**
    * Celery
* **CDN:**
    * Cloudflare

</script>
</section>


<section data-markdown>
<script type="text/template">
<!-- .slide: data-background="#ffffff" -->

![](images/Django-cycle.png) <!-- .element: style="margin-top: 18%" class="noborder stretch" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
<!-- .slide: data-background="#ffffff" -->
## Middleware

![](https://docs.djangoproject.com/en/1.9/_images/middleware.svg) <!-- .element: class="noborder" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Minimalni django projekt

```
import sys

from django.conf import settings
from django.conf.urls import url
from django.core.management import execute_from_command_line
from django.http import HttpResponse

settings.configure(
    DEBUG=True,
    SECRET_KEY='A-random-secret-key!',
    ROOT_URLCONF=sys.modules[__name__],
)


def index(request):
    return HttpResponse('<h1>A minimal Django response!</h1>')

urlpatterns = [
    url(r'^$', index),
]

if __name__ == '__main__':
    execute_from_command_line(sys.argv)
```

Source: <!-- .element: style="font-size: 0.6em;text-align: right; color: gold;" -->
https://github.com/rnevius/minimal-django <!-- .element: style="text-align: right; color: gold;" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Minimalni django projekt

* Izraditi direktorij za projekt i dohvatiti kod
```shell
$ mkdir mwe
$ cd mwe
$ git https://github.com/rnevius/minimal-django.git
```

* Izraditi i aktivirati virtual environment za projekt
```shell
$ virtualenv mwe_env
$ source mwe_env/bin/activate
(mwe_env)$ pip install Django==1.8.9
```

</script>
</section>


<section data-markdown>
<script type="text/template">
## Virtualenv

Okruženje (direktorij) unutar kojega se instaliraju python paketi. U pravilu za svaki python projekt stvara se jedan virtualenv.

![](https://pymote.readthedocs.org/en/latest/_images/virtualenv_system.png)

> The --relocatable option currently has a number of issues, and is not guaranteed to work in all circumstances. It is possible that the option will be deprecated in a future version of virtualenv. <!-- .element: style="font-size: 0.7em;" -->

</script>
</section>

<section data-markdown>
<script type="text/template">
## Pip

Package manager za python

* Instaliranje sa Python Package Index-a:
```shell
(env) $ pip install PAKET[==VERZIJA]
(env) $ pip install -r REQUIREMENTS.txt
```

* Izravno iz repozitorija:
```shell
(env) $ pip install -e git+GIT_REPO_URL@BRANCH|COMMIT|TAG#egg=PAKET
```

* Ispis instaliranih paketa:
```shell
(env) $ pip freeze
Django==1.8.9
some-package==3.2.1
...
```

</script>
</section>


<section data-markdown>
<script type="text/template">
## Minimalni django projekt

* Pokrenuti django razvojni server
```shell
(mwe_env) $ cd minimal-django
(mwe_env) $ python minimal.py runserver 0.0.0.0:8000
```

Posjetiti <!-- .element: class="fragment" data-fragment-index="1" --> http://127.0.0.1:8000/

![](http://crimsonmarketing.com/wp-content/uploads/2015/11/bknation_success3.jpg.png) <!-- .element: width="30%" style="background-color: white" class="fragment" data-fragment-index="1" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Django projekt "Polls"

Source: <!-- .element: style="font-size: 0.6em;text-align: right; color: gold;" --> https://docs.djangoproject.com/en/1.8/intro/tutorial01/

* Priprema okoline:
```shell
$ virtualenv polls_env
$ source polls_env/bin/activate
(polls_env) $ pip install Django==1.8.9
```

* Stvaranje projekta:
<!-- .element: class="fragment" data-fragment-index="1" -->
```shell
(polls_env) $ django-admin startproject polls_project
```
<!-- .element: class="fragment" data-fragment-index="1" -->

* Struktura projekta:
<!-- .element: class="fragment" data-fragment-index="2" -->
```shell
polls_project/  <-- ime nije bitno može se promijeniti u npr. web_polls
    manage.py
    polls_project/  <-- ime je bitno predstavlja ime python paketa koristi
        __init__.py     se na nekoliko mjesta unutar stvorenih datoteka
        settings.py
        urls.py
        wsgi.py
```
<!-- .element: class="fragment" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">

* Promjena imena:
```shell
(polls_env) $ mv polls_project web_polls
(polls_env) $ cd web_polls
```

* Struktura:
<!-- .element: class="fragment" data-fragment-index="1" -->
```shell
web_polls/  <-- direktorij `web_polls` ili njemu nadređeni obično
    manage.py     postaje root VCS repozitorija (git, mercurial)
    polls_project/
        __init__.py
        settings.py
        urls.py
        wsgi.py
```
<!-- .element: class="fragment" data-fragment-index="1" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Settings.py

* Konfiguracijska datoteka projekta
    * Postavke django sustava
    * Redefiniranje (*override*) postavki aplikacija

* Aplikacije koje se koriste u projektu:
<!-- .element: class="fragment" data-fragment-index="1" -->
```py
INSTALLED_APPS = (
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
)
```
<!-- .element: class="fragment" data-fragment-index="1" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## settings.py

```py
import os
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

DEBUG = True

MIDDLEWARE_CLASSES = (
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.auth.middleware.SessionAuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'django.middleware.security.SecurityMiddleware',
)

ROOT_URLCONF = 'polls_project.urls'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}

WSGI_APPLICATION = 'polls_project.wsgi.application'
```

</script>
</section>


<section data-markdown>
<script type="text/template">
## urls.py

* Sadržaj web sjedišta
* Povezuje URL sa funkcijom / metodom koja je zadužena za obradu zahtjeva
<!-- .element: class="fragment" data-fragment-index="1" -->
* Urls.py projekta sastoji se većinom od URLova koji su definirani unutar aplikacija
<!-- .element: class="fragment" data-fragment-index="2" -->
    * U ovom slučaju `django.contrib.admin` aplikacije
    <!-- .element: class="fragment" data-fragment-index="3" -->
    ```py
    from django.conf.urls import include, url
    from django.contrib import admin

    urlpatterns = [
        url(r'^admin/', include(admin.site.urls)),
    ]
    ```
    <!-- .element: class="fragment" data-fragment-index="3" -->
</script>
</section>

<section data-markdown>
<script type="text/template">
## Aplikacija vs projekt

* Oba su python paketi
* Django aplikacija
    * rješava jedan problem
        * npr. rad s datotekama, registracija korisnika, tagiranje
    * *reusable* - može se koristiti u više projekata
        * veliki broj gotovih django aplikacija
        * https://www.djangopackages.com/


* Django projekt je idealno:
    * skup funkcija implementiranih u django aplikacijama
    * popis i konfiguracija instaliranih aplikacija
    * korijenski `urls.py`

</script>
</section>



<section data-markdown>
<script type="text/template">
## Django aplikacija

* Aplikaciju stvaramo unutar direktorija  `polls_project`
```shell
(polls_env) $ python manage.py startapp polls
```
* Aplikacija kao i svaki drugi python paket može se smjestiti na proizvoljnu lokaciju,
    * samo je potrebno osigurati da je Python interpreter može pronaći
* Struktura:
```shell
polls/
    __init__.py
    admin.py
    migrations/
        __init__.py
    models.py
    tests.py
    views.py
```

</script>
</section>

<section data-markdown>
<script type="text/template">
## Instalacija aplikacije

* Uključiti `polls` u `INSTALLED_APPS`:
```py
INSTALLED_APPS = (
    'polls',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
)
```
    `settings.py` <!-- .element: class="filename" -->

</script>
</section>

<section data-markdown>
<script type="text/template">
## models.py

```py
from django.db import models


class Question(models.Model):
    question_text = models.CharField(max_length=200)
    pub_date = models.DateTimeField('date published')


class Choice(models.Model):
    question = models.ForeignKey(Question)
    choice_text = models.CharField(max_length=200)
    votes = models.IntegerField(default=0)
```

![](images/polls_models.png)

</script>
</section>

<section data-markdown>
<script type="text/template">
## Digresija: ispis modela

* Powered by graphviz & Django extensions:
```shell
apt-get update
apt-get install graphviz
pip install django_extensions pygraphviz
```

* Ispis modela jedne aplikacije:
<!-- .element: class="fragment" data-fragment-index="1" -->
```shell
python manage.py graph_models -o models.png polls
```
<!-- .element: class="fragment" data-fragment-index="1" -->

* Ispis modela svih instaliranih aplikacija, grupirano:
<!-- .element: class="fragment" data-fragment-index="2" -->
```shell
python manage.py graph_models -a -g -o models.png
```
<!-- .element: class="fragment" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
<!-- .slide: data-background="#ffffff" -->
![](images/polls_models_all_grouped.png) <!-- .element: width="80%" class="noborder nomargin" -->
</script>
</section>


<section data-markdown>
<script type="text/template">
## Migracije

* Pokušajmo pokrenuti django dev server:
```shell
$ python manage.py runserver 0.0.0.0:8000
```
```shell
You have unapplied migrations; your app may not work properly
until they are applied.
Run 'python manage.py migrate' to apply them.
```
<!-- .element: style="color: red" class="fragment" data-fragment-index="1" -->
```shell
$ python manage.py migrate
Operations to perform:
  Synchronize unmigrated apps: staticfiles, django_extensions, messages
  Apply all migrations: admin, contenttypes, auth, sessions
Synchronizing apps without migrations:
  Creating tables...
    Running deferred SQL...
  Installing custom SQL...
Running migrations:
  Rendering model states... DONE
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  ...
```
<!-- .element: class="fragment" data-fragment-index="2" -->
</script>
</section>


<section data-markdown>
<script type="text/template">
## Baza podataka

* Ispis novokreiranih tablica
```shell
$ apt-get install sqlite3
```
```shell
$ sqlite3 db.sqlite
sqlite> .tables
auth_group                  auth_user_user_permissions
auth_group_permissions      django_admin_log
auth_permission             django_content_type
auth_user                   django_migrations
auth_user_groups            django_session
sqlite> .q
```
* Nema tablica `polls_choice` i `polls_question`!?

</script>
</section>


<section data-markdown>
<script type="text/template">
* Potrebno je stvoriti migracijske skripte i za aplikaciju polls
```shell
$ python manage.py makemigrations polls
Migrations for 'polls':
  0001_initial.py:
    - Create model Choice
    - Create model Question
    - Add field question to choice
```
```shell
$ ls polls/migrations/
0001_initial.py   __init__.py
```
* I primjeniti ih:
<!-- .element: class="fragment" data-fragment-index="1" -->
```shell
$ python manage.py migrate
...
  Applying polls.0001_initial... OK
```
<!-- .element: class="fragment" data-fragment-index="1" -->
```shell
$ sqlite3 db.sqlite
sqlite> .tables
...
polls_choice                polls_question
```
<!-- .element: class="fragment" data-fragment-index="2" -->
</script>
</section>


<section data-markdown>
<script type="text/template">
## Workflow

* 3 koraka
    1. Promjena modela u `models.py`
    2. Kreiranje migracijskih skripti:
    ```shell
    $ python manage.py makemigrations
    ```
    3. Aplicirane promjena u bazu pokretanjem migracijskih skripti:
    ```shell
    $ python manage.py migrate
    ```
</script>
</section>


<section data-markdown>
<script type="text/template">
## Rad s modelima

* Django omogućava korištenje interaktivne konzole:
```shell
$ python manage.py shell
```

```py
>>> from polls.models import Choice, Question

# Još nema pitanja u sustavu
>>> Question.objects.all()
[]
```
<!-- .element: class="fragment" data-fragment-index="1" -->

```py
>>> from django.utils import timezone
>>> q = Question(question_text="Što ima?", pub_date=timezone.now())

# Spremimo pitanje u bazu. Potrebno je kesplicitno pozvati save() metodu.
>>> q.save()

# Zapis nakon spremanja ima id.
>>> q.id
1
```
<!-- .element: class="fragment" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
```py
# Vrijednosti polja spremljenog zapisa mogu se dohvatiti preko atributa objekta.
>>> q.question_text
"Što ima?"
>>> q.pub_date
datetime.datetime(2016, 3, 3, 19, 1, 2, 775217, tzinfo=<UTC>)
```
```py
# Vrijednosti se mogu izmijeniti nakon čega je potrebno pozvati save().
>>> q.question_text = "What has!?"
>>> q.save()
```
<!-- .element: class="fragment" data-fragment-index="1" -->
```shell
$ sqlite3 db.sqlite3
sqlite> SELECT * FROM polls_question;
1|What has!?|2016-03-03 19:01:02.845000
```
<!-- .element: class="fragment" data-fragment-index="2" -->

```py
# Atribut objects je predefinirani manager za model, a jedna od metoda koju implementira
# je .all() koja vraća listu svih zapisa u bazi.
>>> Question.objects.all()
[<Question: Question object>]
```
<!-- .element: class="fragment" data-fragment-index="3" -->

```py
# Rezultat nije obična lista već QuerySet objekt koji možemo dodatno segmentirati ili
# filtrirati bez višestrukih upita baze, agregirani upit u bazu se obavlja tek kada se
# QuerySet evaluira
>>> type(Question.objects.all())
<class 'django.db.models.query.QuerySet'>
```
<!-- .element: class="fragment" data-fragment-index="4" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
```py
from django.db import models

class Question(models.Model):
    # ...
    def __unicode__(self):
        return self.question_text

class Choice(models.Model):
    # ...
    def __unicode__(self):
        return self.choice_text
```
`models.py`  <!-- .element: class="filename" -->

> Ovako generirana imena zapisa koriste se i u automatski generiranom administracijskom sučelju

```py
>>> from polls.models import Question, Choice

>>> Question.objects.all()
[<Question: What has!?>]
```
<!-- .element: class="fragment" data-fragment-index="1" -->
</script>
</section>


<section data-markdown>
<script type="text/template">
```py
# filter je još jedna metoda model managera 'objects'
>>> Question.objects.filter(id=1)
[<Question: What has!?>]
>>> Question.objects.filter(question_text__startswith='Što')
[]
>>> Question.objects.filter(question_text__startswith='What')
[<Question: What has!?>]
```

```py
# Dohvat pitanja objavljenih ove godine
>>> from django.utils import timezone
>>> current_year = timezone.now().year
>>> Question.objects.get(pub_date__year=current_year)
<Question: What has!?>
```
<!-- .element: class="fragment" data-fragment-index="1" -->

```py
# Metoda get dohvaća isključivo jedan objekt s navedenim kriterijima, ako ih je više
# stvara se iznimka MultipleObjectsReturned, a ako takvih objekata nema iznimka DoesNotExist
>>> Question.objects.get(pk=2)
Traceback (most recent call last):
    ...
DoesNotExist: Question matching query does not exist.
```
<!-- .element: class="fragment" data-fragment-index="2" -->
</script>
</section>


<section data-markdown>
<script type="text/template">
## Dodatne metode
```py
import datetime

from django.db import models
from django.utils import timezone


class Question(models.Model):
    # ...
    def was_published_recently(self):
        return self.pub_date >= timezone.now() - datetime.timedelta(days=1)
```
`models.py` <!-- .element: class="filename" -->

```py
>>> q = Question.objects.get(pk=1)
>>> q.was_published_recently()
True
```
<!-- .element: class="fragment" data-fragment-index="1" -->
</script>
</section>


<section data-markdown>
<script type="text/template">

```py
# Stvorimo tri izbora.
>>> q.choice_set.create(choice_text='Not much', votes=0)
<Choice: Not much>
>>> q.choice_set.create(choice_text='The sky', votes=0)
<Choice: The sky>
>>> c = q.choice_set.create(choice_text='Just hacking again', votes=0)
```

```py
# Objekt koji predstavlja izbor ima atribut kojim je povezan s pitanjem iz stranog ključa
>>> c.question
<Question: What has!?>
```
<!-- .element: class="fragment" data-fragment-index="1" -->

```py
# Veza u drugom smjeru stranog ključa je preko managera. Ime managera se automatski stvara od
# imena modela uz dodatak '_set', primjerice `choice_set`
>>> q.choice_set.all()
[<Choice: Not much>, <Choice: The sky>, <Choice: Just hacking again>]
>>> q.choice_set.count()
3
```
<!-- .element: class="fragment" data-fragment-index="2" -->


```py
# Svi izbori čije pitanje je objavljeno ove godine:
# (varijabla 'current_year' je definirana u prethodnom primjeru).
>>> Choice.objects.filter(question__pub_date__year=current_year)
[<Choice: Not much>, <Choice: The sky>, <Choice: Just hacking again>]
```
<!-- .element: class="fragment" data-fragment-index="3" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Auth i Admin
* `django.contrib.auth` i `django.contrib.admin`
    * uključene u defaultni `INSTALLED_APPS`
* `django.contrib.auth` - autentikacija i autorizacija
<!-- .element: class="fragment" data-fragment-index="1" -->
    * rad s korisnicima, grupama korisnika i ovlastima <!-- .element: class="fragment" data-fragment-index="2" -->
    ```shell
    $ python manage.py createsuperuser
    ```
    <!-- .element: class="fragment" data-fragment-index="3" -->

* `django.contrib.admin` - autentikacija i autorizacija
<!-- .element: class="fragment" data-fragment-index="4" -->
    * omogućava brzo i jednostavno stvaranje sučelja za uređivanje modela instaliranih aplikacija
    <!-- .element: class="fragment" data-fragment-index="5" -->
    ```shell
    $ python manage.py runserver 0.0.0.0:8000
    ```
    <!-- .element: class="fragment" data-fragment-index="6" -->
    * <!-- .element: class="fragment" data-fragment-index="7" --> http://127.0.0.1:8000/admin/

</script>
</section>


<section data-markdown>
<script type="text/template">
## Polls admin

```py
from django.contrib import admin

from .models import Question

admin.site.register(Question)
```
`polls/admin.py` <!-- .element: class="filename" -->

```py
from django.contrib import admin

from .models import Choice, Question


class ChoiceInline(admin.StackedInline):
    model = Choice
    extra = 3


class QuestionAdmin(admin.ModelAdmin):
    fieldsets = [
        (None,               {'fields': ['question_text']}),
        ('Date information', {'fields': ['pub_date'], 'classes': ['collapse']}),
    ]
    inlines = [ChoiceInline]

admin.site.register(Question, QuestionAdmin)
```
<!-- .element: class="fragment" data-fragment-index="1" -->
`polls/admin.py` <!-- .element: class="filename fragment" data-fragment-index="1" -->
</script>
</section>

<section data-markdown>
<script type="text/template">
```py
class QuestionAdmin(admin.ModelAdmin):
    # ...
    # prikaz popisa
    list_display = ('question_text', 'pub_date', 'was_published_recently')
```
`polls/admin.py` <!-- .element: class="filename" -->

```py
class Question(models.Model):
    # ...
    def was_published_recently(self):
        return self.pub_date >= timezone.now() - datetime.timedelta(days=1)
    was_published_recently.admin_order_field = 'pub_date'
    was_published_recently.boolean = True
    was_published_recently.short_description = 'Published recently?'
```
<!-- .element: class="fragment" data-fragment-index="1" -->
`polls/models.py` <!-- .element: class="filename fragment" data-fragment-index="1" -->

```py
class QuestionAdmin(admin.ModelAdmin):
    # ...
    # filtriranje i pretraživanje
    list_filter = ['pub_date']
    search_fields = ['question_text']
```
<!-- .element: class="fragment" data-fragment-index="2" -->
`polls/admin.py` <!-- .element: class="filename fragment" data-fragment-index="2" -->
</script>
</section>

<section data-markdown>
<script type="text/template">
## Views.py

* Definira tip web stranice unutar aplikacije koja ima određenu funkciju
    * implementiran kao funkcija ili metode u datoteci `views.py`
    * vezan uz određeni url
    * renderira se koristeći određeni template

* Primjeri
    * `index` - početna stranica ispisuje nekoliko recentnih pitanja
    * `question_detail` - prikazuje tekst pitanja i formular za glasanje
    * `question_results` - prikazuje rezultate za pojedino pitanje
    * `vote_action` - obrađuje glas za pojedini izbor na pojedinom pitanju

</script>
</section>

<section data-markdown>
<script type="text/template">
## Index view
```py
# -*- coding: utf-8 -*-
from django.http import HttpResponse


def index(request):
    return HttpResponse("Dobrodošli! Ovo je početna stranica aplikacije polls.")
```
`polls/views.py` <!-- .element: class="filename" -->

```py
from django.conf.urls import url

from . import views

urlpatterns = [
    url(r'^$', views.index, name='index'),
]
```
<!-- .element: class="fragment" data-fragment-index="1" -->
`polls/urls.py` <!-- .element: class="filename fragment" data-fragment-index="1" -->

```py
from django.conf.urls import include, url
from django.contrib import admin

urlpatterns = [
    url(r'^polls/', include('polls.urls')),
    url(r'^admin/', include(admin.site.urls)),
]
```
<!-- .element: class="fragment" data-fragment-index="2" -->
`polls_project/urls.py` <!-- .element: class="filename fragment" data-fragment-index="2" -->
</script>
</section>

<section data-markdown>
<script type="text/template">
## urls.py

* `urlpatterns` - lista koja mapira url uzorak s odgovarajućom funkcijom
* korištenjem funkcije `url()`:
    ```py
    url(regex, view, kwargs, name)
    ```
    * `regex` - regularni izraz s kojim se uspoređuje url iz zahtjeva
    * `view` - funkcija za odgovarajući zahtjev; argumenti funkcije:
        * `request` objekt te
        * argumenti dobiveni iz grupa u `regex`-u
    * `kwargs` - dodatni imenovani argumenti koji se prosljeđuju funkciji
    * `name` - ime uzorka, koristiti se za povratno razrješenje URL-a
* Primjer:
    ```py
    url(r'^$', views.index, name='index')
    ```

</script>
</section>


<section data-markdown>
<script type="text/template">
```py
def detail(request, question_id):
    return HttpResponse("You're looking at question %s." % question_id)

def results(request, question_id):
    response = "You're looking at the results of question %s."
    return HttpResponse(response % question_id)

def vote(request, question_id):
    return HttpResponse("You're voting on question %s." % question_id)
```
`polls/views.py` <!-- .element: class="filename" -->

```py
urlpatterns = [
    # ex: /polls/
    url(r'^$', views.index, name='index'),
    # ex: /polls/5/
    url(r'^(?P<question_id>[0-9]+)/$', views.detail, name='detail'),
    # ex: /polls/5/results/
    url(r'^(?P<question_id>[0-9]+)/results/$', views.results, name='results'),
    # ex: /polls/5/vote/
    url(r'^(?P<question_id>[0-9]+)/vote/$', views.vote, name='vote'),
]
```
`polls/urls.py` <!-- .element: class="filename" -->

* primjer http://127.0.0.1/polls/34/vote/
    * Glasanje za pitanje 34
    * Vrijednost argumenta funkcije `question_id='34'` proizlazi iz `(?P<question_id>[0-9]+)`
</script>
</section>


<section data-markdown>
<script type="text/template">
## Dohvat iz baze

```py
def index(request):
    # dohvati prvih pet pitanja sortiranih po datumu objave, od najnovijih
    latest_question_list = Question.objects.order_by('-pub_date')[:5]
    output = ', '.join([p.question_text for p in latest_question_list])
    return HttpResponse(output)
```
<div>What has!?, K'o će burek?</div>
<!-- .element: class="html fragment" data-fragment-index="1" -->

* Problem: tijelo odgovora je hardkodirano u python funkciji <!-- .element: class="fragment" data-fragment-index="2" -->
* Rješenje: predlošci! <!-- .element: class="fragment" data-fragment-index="3" -->

</script>
</section>

<section data-markdown>
<script type="text/template">
## Templates
```
{% if latest_question_list %}
    <ul>
    {% for question in latest_question_list %}
        <li><a href="/polls/{{ question.id }}/">{{ question.question_text }}</a></li>
    {% endfor %}
    </ul>
{% else %}
    <p>No polls are available.</p>
{% endif %}
```
`polls/templates/polls/index.html` <!-- .element: class="filename" -->

```py
from django.template import loader
# ...

def index(request):
    latest_question_list = Question.objects.order_by('-pub_date')[:5]
    template = loader.get_template('polls/index.html')
    context = {
        'latest_question_list': latest_question_list,
    }
    return HttpResponse(template.render(context, request))
```
<!-- .element: class="fragment" data-fragment-index="1" -->
`polls/views.py` <!-- .element: class="filename fragment" data-fragment-index="1" -->

<div>
    <ul>
        <li><a href="/polls/1/">What has!?</a></li>
        <li><a href="/polls/2/">K&#39;o će burek?</a></li>
    </ul>
</div>
<!-- .element: class="html fragment" data-fragment-index="2" -->

</script>
</section>

<section data-markdown>
<script type="text/template">
## Kratica render

```py
from django.shortcuts import render
# ...

def index(request):
    latest_question_list = Question.objects.order_by('-pub_date')[:5]
    context = {'latest_question_list': latest_question_list}
    return render(request, 'polls/index.html', context)
```

* učitava predložak
* popunjava kontekst
* vraća `HttpResponse` objekt s rezultatom renderiranja

</script>
</section>

<section data-markdown>
<script type="text/template">
## Question details

```py
from django.http import Http404
# ...

def detail(request, question_id):
    try:
        question = Question.objects.get(pk=question_id)
    except Question.DoesNotExist:
        raise Http404("Trazeno pitanje ne postoji.")
    return render(request, 'polls/detail.html', {'question': question})
```
`polls/views.py` <!-- .element: class="filename" -->

```
{{ question }}
```
<!-- .element: class="fragment" data-fragment-index="1" -->
`polls/templates/polls/detail.html` <!-- .element: class="filename fragment" data-fragment-index="1" -->

http://127.0.0.1:8000/polls/1/ <!-- .element: class="fragment" data-fragment-index="2" -->

<div>What has!?</div>
<!-- .element: class="html fragment" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
* Kratica `get_object_or_404`
    * pokušava dohvatiti objekt koristeći `get` ako ne uspije stvara `Http404` iznimku

```py
from django.shortcuts import get_object_or_404, render
# ...

def detail(request, question_id):
    question = get_object_or_404(Question, pk=question_id)
    return render(request, 'polls/detail.html', {'question': question})
#
```
`polls/templates/polls/detail.html` <!-- .element: class="filename" -->
```
<h1>{{ question.question_text }}</h1>
<ul>
{% for choice in question.choice_set.all %}
    <li>{{ choice.choice_text }}</li>
{% endfor %}
</ul>
```
<!-- .element: class="fragment" data-fragment-index="1" -->

<div><h1>What has!?</h1><ul><li>Not much</li><li>The sky</li><li>Just hacking again</li></ul></div> <!-- .element: class="html fragment" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
```
<li>
    <a href="/polls/{{ question.id }}/">{{ question.question_text }}</a>
</li>
```
`polls/templates/polls/index.html` <!-- .element: class="filename" -->

```py
    url(r'^polls/', include('polls.urls')),
```
`polls_project/urls.py` <!-- .element: class="filename" -->

```py
    url(r'^(?P<question_id>[0-9]+)/$', views.detail, name='detail'),
```
`polls/urls.py` <!-- .element: class="filename" -->

* Dva problema:
<!-- .element: class="fragment" data-fragment-index="1" -->
    * kršenje DRY principa
<!-- .element: class="fragment" data-fragment-index="1" -->
    * kako aplikacija može znati pod kojim urlom će biti posluživana unutar projekta
<!-- .element: class="fragment" data-fragment-index="1" -->

* Rješenje: imenovanje URLova i povratno razrješenje
<!-- .element: class="fragment" data-fragment-index="2" -->

```
<li>
    <a href="{% url 'detail' question.id %}">{{ question.question_text }}</a>
</li>
```
<!-- .element: class="fragment" data-fragment-index="2" -->
`polls/templates/polls/detail.html` <!-- .element: class="filename fragment" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## URL namespaces

* Problem: više različitih aplikacija može dijeliti isto ime URLa
    * Rješenje: *application namespace*

```py
from django.conf.urls import include, url
from django.contrib import admin

urlpatterns = [
    url(r'^polls/', include('polls.urls', namespace="polls")),
    url(r'^admin/', include(admin.site.urls)),
]

```
`polls_project/urls.py` <!-- .element: class="filename" -->

```
<li>
    <a href="{% url 'polls:detail' question.id %}">{{ question.question_text }}</a>
</li>
```
`polls/templates/polls/index.html` <!-- .element: class="filename" -->

* Dodatni problem: jedna aplikacija može biti uključena više puta u isti projekt na različitim urlovima.
<!-- .element: class="fragment" data-fragment-index="1" -->
    * Rješenje: *instance namespace*
<!-- .element: class="fragment" data-fragment-index="1" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Form

```
<h1>{{ question.question_text }}</h1>

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

<form action="{% url 'polls:vote' question.id %}" method="post">
{% csrf_token %}
{% for choice in question.choice_set.all %}
    <input type="radio" name="choice"
           id="choice{{ forloop.counter }}" value="{{ choice.id }}" />
    <label for="choice{{ forloop.counter }}">{{ choice.choice_text }}</label><br />
{% endfor %}
<input type="submit" value="Vote" />
</form>
```
`polls/templates/polls/detail.html` <!-- .element: class="filename" -->

```
<h1>What has!?</h1>
<form action="/polls/1/vote/" method="post">
<input type='hidden' name='csrfmiddlewaretoken' value='LBBTSrDGzNtCt9levIsZGxFexb2aCuK4' />
    <input type="radio" name="choice" id="choice1" value="1" />
    <label for="choice1">Not much</label><br />
    <input type="radio" name="choice" id="choice2" value="2" />
    <label for="choice2">The sky</label><br />
    <input type="radio" name="choice" id="choice3" value="3" />
    <label for="choice3">Just hacking again</label><br />
<input type="submit" value="Vote" />
</form>
```
<!-- .element: class="fragment hide" data-fragment-index="1" -->

<div><h1>What has!?</h1>
<form action="/polls/1/vote/" method="post">
<input type='hidden' name='csrfmiddlewaretoken' value='LBBTSrDGzNtCt9levIsZGxFexb2aCuK4' />
    <input type="radio" name="choice" id="choice1" value="1" />
    <label for="choice1">Not much</label><br />
    <input type="radio" name="choice" id="choice2" value="2" />
    <label for="choice2">The sky</label><br />
    <input type="radio" name="choice" id="choice3" value="3" />
    <label for="choice3">Just hacking again</label><br />
<input type="submit" value="Vote" />
</form>
</div> <!-- .element: class="html fragment hide" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Form view

```py
from django.shortcuts import get_object_or_404, render
from django.http import HttpResponseRedirect, HttpResponse
from django.core.urlresolvers import reverse

from .models import Choice, Question
# ...

def vote(request, question_id):
    p = get_object_or_404(Question, pk=question_id)
    try:
        selected_choice = p.choice_set.get(pk=request.POST['choice'])
    except (KeyError, Choice.DoesNotExist):
        # Ponovno ispisi form uz poruku o pogresci
        return render(request, 'polls/detail.html', {
            'question': p,
            'error_message': "Molimo izaberite jedan od ponudjenih odgovora.",
        })
    else:
        selected_choice.votes += 1
        selected_choice.save()
        # Vracanje HttpResponseRedirect objekta nakon uspjesnog slanja podataka
        # onemogucava visestruko slanje istih podataka klikom na Back u browseru.
        return HttpResponseRedirect(reverse('polls:results', args=(p.id,)))
```
`polls/views.py` <!-- .element: class="filename" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Rezultati

```py
def results(request, question_id):
    question = get_object_or_404(Question, pk=question_id)
    return render(request, 'polls/results.html', {'question': question})
```
`polls/views.py` <!-- .element: class="filename" -->

```
<h1>{{ question.question_text }}</h1>
<ul>
{% for choice in question.choice_set.all %}
    <li>{{ choice.choice_text }} -- {{ choice.votes }} vote{{ choice.votes|pluralize }}</li>
{% endfor %}
</ul>

<a href="{% url 'polls:detail' question.id %}">Želite li glasati ponovno?</a>
<!-- -->

```
<!-- .element: class="fragment" data-fragment-index="1" -->
`polls/templates/polls/results.html` <!-- .element: class="filename fragment" data-fragment-index="1" -->

<div><h1>What has!?</h1>
<ul>
    <li>Not much -- 0 vote</li>
    <li>The sky -- 1 vote</li>
    <li>Just hacking again -- 0 votes</li>
</ul>

<a href="/polls/1/">Želite li glasati ponovno?</a>

</div>
<!-- .element: class="html fragment" data-fragment-index="2" -->

</script>
</section>


<section data-markdown>
<script type="text/template">
## Class based views

```py
urlpatterns = [
    url(r'^$', views.IndexView.as_view(), name='index'),
    url(r'^(?P<pk>[0-9]+)/$', views.DetailView.as_view(), name='detail'),
    url(r'^(?P<pk>[0-9]+)/results/$', views.ResultsView.as_view(), name='results'),
    url(r'^(?P<question_id>[0-9]+)/vote/$', views.vote, name='vote'),
]
```
`polls/urls.py` <!-- .element: class="filename" -->

```py
from django.views import generic

class IndexView(generic.ListView):
    template_name = 'polls/index.html'
    context_object_name = 'latest_question_list'

    def get_queryset(self):
        """Vraca pet zadnjih objavljenih pitanja."""
        return Question.objects.order_by('-pub_date')[:5]


class DetailView(generic.DetailView):
    model = Question
    template_name = 'polls/detail.html'


class ResultsView(generic.DetailView):
    model = Question
    template_name = 'polls/results.html'

```

</script>
</section>

<section data-markdown>
<script type="text/template">
## Static files

* js, css, slike...
    * Kod razvoja korištenjem django razvojnog servera poslužuje ih sam Django
    * U produkciji poslužuje ih web server (Nginx, Apache) ili CDN
* Aplikacija `django.contrib.staticfiles`:
    * prikuplja statičke datoteke svih aplikacija na jedno mjesto
    ```shell
    $ python manage.py collectstatic
    ```
    * Postavka `STATICFILES_FINDERS` definira klase zadužene za prikupljanje
    * npr. `AppDirectoriesFinder` prikuplja datoteke iz `static` poddirektorija svih aplikacija iz `INSTALLED_APPS`
</script>
</section>

<section data-markdown>
<script type="text/template">
## Static files

```css
li a {
  color: green;
}
```
`polls/static/polls/style.css`<!-- .element: class="filename" -->

```
{% load staticfiles %}

<link rel="stylesheet" type="text/css" href="{% static 'polls/style.css' %}" />
<!-- -->
```
<!-- .element: class="fragment" data-fragment-index="1" -->
`polls/templates/polls/index.html`<!-- .element: class="filename fragment" data-fragment-index="1" -->

<div>
<link rel="stylesheet" type="text/css" href="/static/polls/style.css" />
    <ul>
        <li><a style="color: green;" href="/polls/1/">What has!?</a></li>
        <li><a style="color: green;" href="/polls/2/">K&#39;o će burek?</a></li>
    </ul>
</div> <!-- .element: class="html fragment" data-fragment-index="2" -->
</script>
</section>



<section data-markdown>
<script type="text/template">
## Debugiranje

```py
import pdb; pdb.set_trace()
```
```shell
(Pdb) l
 16         return HttpResponse(template.render(context, request))
 17
 18
 19     def detail(request, question_id):
 20         import pdb; pdb.set_trace()
 21  ->     try:
 22             question = Question.objects.get(pk=question_id)
 23         except Question.DoesNotExist:
 24             raise Http404("Trazeno pitanje ne postoji.")
 25         return render(request, 'polls/detail.html', {'question': question})
 26
(Pdb) h

Documented commands (type help <topic>):
========================================
EOF    bt         cont      enable  jump  pp       run      unt
a      c          continue  exit    l     q        s        until
alias  cl         d         h       list  quit     step     up
args   clear      debug     help    n     r        tbreak   w
b      commands   disable   ignore  next  restart  u        whatis
break  condition  down      j       p     return   unalias  where
```
</script>
</section>



<section data-markdown>
<script type="text/template">
## Savjeti za kraj

> Fat models, thin views and dumb templates

i

> Test test test

</script>
</section>


<section data-markdown>
<script type="text/template">
## Dalje?

* Literatura:
    * Django dokumentacija
    * Django source
    * https://www.djangopackages.com/categories/apps/
        * više od 3000 django aplikacija
    * Two scoops of django
    * http://www.pyvideo.org/ (uskoro se gasi)

</script>
</section>



</div>
</div>

<script src="vendor/reveal.js/lib/js/head.min.js"></script>
<script src="vendor/reveal.js/js/reveal.js"></script>
<script type="text/javascript" src="vendor/reveal-initialize.js"></script>

</body>
</html>
